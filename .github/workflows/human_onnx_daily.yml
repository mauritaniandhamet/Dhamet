# Section: .github/workflows/human_onnx_daily.yml â€” YAML configuration
name: Train Human ONNX (daily)

on:
  schedule:
    - cron: "17 1 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: human-onnx-daily
  cancel-in-progress: false

jobs:
  train:
    runs-on: ubuntu-22.04

    env:

      FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL || vars.FIREBASE_DATABASE_URL }}
      FIREBASE_DB_SECRET: ${{ secrets.FIREBASE_DB_SECRET || vars.FIREBASE_DB_SECRET }}
      FIREBASE_SERVICE_ACCOUNT_JSON_RAW: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON || vars.FIREBASE_SERVICE_ACCOUNT_JSON }}


      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PIP_NO_CACHE_DIR: "1"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Disk space (before)
        run: df -h

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo apt-get clean || true
          df -h

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Normalize Firebase service account secret (JSON or base64)
        shell: bash
        run: |
          python - <<'PY'
          import os, json, base64, sys

          raw = (os.environ.get("FIREBASE_SERVICE_ACCOUNT_JSON_RAW") or "").strip()
          if not raw:

              print("No service account JSON provided (will use DB secret if available).")
              sys.exit(0)


          try:
              json.loads(raw)
              out = raw
              mode = "raw-json"
          except Exception:

              try:
                  decoded = base64.b64decode(raw).decode("utf-8")
                  json.loads(decoded)
                  out = decoded
                  mode = "base64->json"
              except Exception:
                  print("::error::FIREBASE_SERVICE_ACCOUNT_JSON is not valid JSON and not base64-encoded JSON.")
                  print("::error::Fix the secret: store the exact service account JSON, or store base64 of the JSON file.")
                  sys.exit(1)


          env_file = os.environ["GITHUB_ENV"]
          with open(env_file, "a", encoding="utf-8") as f:
              f.write("FIREBASE_SERVICE_ACCOUNT_JSON<<EOF\n")
              f.write(out)
              f.write("\nEOF\n")

          print(f"Service account secret accepted ({mode}).")
          PY

      - name: Validate Firebase configuration
        shell: bash
        run: |
          if [ -z "${FIREBASE_DATABASE_URL}" ]; then
            echo "::error::Missing FIREBASE_DATABASE_URL."
            exit 1
          fi


          if [ -z "${FIREBASE_SERVICE_ACCOUNT_JSON}" ] && [ -z "${FIREBASE_DB_SECRET}" ]; then
            echo "::error::Provide FIREBASE_SERVICE_ACCOUNT_JSON (valid JSON) or FIREBASE_DB_SECRET."
            exit 1
          fi

          echo "Firebase configuration looks present (values not printed)."

      - name: Install dependencies (CPU-only PyTorch, no cache)
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir \
            --index-url https://download.pytorch.org/whl/cpu \
            --extra-index-url https://pypi.org/simple \
            -r training/requirements-train.txt

      - name: Install ONNX dependencies
        run: |
          pip install --no-cache-dir --upgrade onnxscript onnx

      - name: Disk space (after installs)
        run: df -h

      - name: Prepare (download new games, filter, train, export ONNX, stage outputs)
        run: |
          python training/train_human_onnx.py prepare --repo-root .

      - name: Commit and push model artifacts (if changed)
        id: commit_push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add assets/models/human training/_out || true

          if git diff --cached --quiet; then
            echo "No model file changes to commit."
            echo "pushed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "chore: update human learned model"
            git push
            echo "pushed=true" >> $GITHUB_OUTPUT
          fi

      - name: Apply to Firebase (update pointers, mark processed, purge)
        run: |
          python training/train_human_onnx.py apply --repo-root .
